<div class="container py-4">
  <h1 class="mb-4 text-primary">Gestión de Ventas</h1>

  <!-- 🧭 Navegación -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-outline-primary" (click)="vista = 'listar'">📋 Listar</button>
    <button class="btn btn-outline-success" (click)="vista = 'crear'">➕ Nueva Venta</button>
  </div>

  <!-- 🔍 Filtros -->
  <div *ngIf="vista === 'listar'" class="card mb-4">
    <div class="card-header">Filtros</div>
    <div class="card-body row g-2">
      <div class="col-md-4">
        <input class="form-control" [(ngModel)]="filtroNombreCliente" placeholder="🔎 Nombre del cliente" />
      </div>
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="filtroMetodoPago">
          <option value="">Todos los métodos</option>
          <option value="EFECTIVO">Efectivo</option>
          <option value="TARJETA">Tarjeta</option>
          <option value="YAPE">Yape</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" [(ngModel)]="filtroFechaInicio" />
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" [(ngModel)]="filtroFechaFin" />
      </div>
      <div class="col-md-1">
        <button class="btn btn-dark w-100" (click)="aplicarFiltro()">🔍</button>
      </div>
    </div>
  </div>

  <!-- 📋 Tabla de Ventas -->
  <div *ngIf="vista === 'listar'" class="card">
    <div class="card-header bg-dark text-white">Ventas Registradas</div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Pedido</th>
          <th>Total</th>
          <th>Método</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let v of ventas">
          <td>{{ v.id }}</td>
          <td>{{ v.cliente }}</td>
          <td>{{ v.pedidoId }}</td>
          <td>{{ v.total | currency:'PEN' }}</td>
          <td>{{ v.metodoPago }}</td>
          <td>{{ v.fecha | date:'short' }}</td>
          <td>
            <div class="d-flex">
              <button class="btn btn-sm btn-warning me-1" (click)="editarVenta(v)">✏️</button>
              <button class="btn btn-sm btn-danger me-1" (click)="eliminarVenta(v.id)">🗑️</button>
              <button class="btn btn-sm btn-info" (click)="verPromociones(v.pedidoId)">🎁</button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 🎁 Promociones disponibles -->
  <div *ngIf="promocionesActivas.length" class="alert alert-info mt-3">
    <strong>Promociones aplicables:</strong>
    <ul>
      <li *ngFor="let p of promocionesActivas">{{ p.nombre }} - {{ p.descripcion }}</li>
    </ul>
  </div>

  <!-- 🧾 Formulario Crear/Editar -->
  <div *ngIf="vista === 'crear' || vista === 'editar'" class="card mt-4">
    <div class="card-header">
      {{ vista === 'crear' ? 'Registrar Venta' : 'Editar Venta' }}
    </div>
    <div class="card-body">
      <form (ngSubmit)="guardarVenta()" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Cliente</label>
          <input type="text" class="form-control" [(ngModel)]="ventaForm.cliente" name="cliente" required />
        </div>

        <div class="col-md-6">
          <label class="form-label">Pedido ID</label>
          <input type="number" class="form-control" [(ngModel)]="ventaForm.pedidoId" name="pedidoId" required />
        </div>

        <div class="col-md-6">
          <label class="form-label">Método de Pago</label>
          <select class="form-select" [(ngModel)]="ventaForm.metodoPago" name="metodoPago">
            <option value="EFECTIVO">Efectivo</option>
            <option value="TARJETA">Tarjeta</option>
            <option value="YAPE">Yape</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Total</label>
          <input type="number" class="form-control" [(ngModel)]="ventaForm.total" name="total" />
        </div>

        <div class="col-12 mt-3">
          <button type="submit" class="btn btn-success me-2">
            {{ vista === 'editar' ? 'Actualizar' : 'Registrar' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelar()">Cancelar</button>
        </div>
      </form>

      <!-- 📦 Pedidos no vendidos por cliente -->
      <div *ngIf="pedidosNoVendidos.length" class="mt-3">
        <div class="alert alert-warning">
          <strong>Pedidos no vendidos para este cliente:</strong>
          <ul>
            <li *ngFor="let pedido of pedidosNoVendidos">
              ID Pedido: {{ pedido.id }} - Total: {{ pedido.total | currency:'PEN' }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
